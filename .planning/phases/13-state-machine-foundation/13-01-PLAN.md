---
phase: 13-state-machine-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/stores/graph-store.tsx
  - lib/layout-constants.ts
  - components/sections/graph-section.tsx
  - components/custom-node.tsx
autonomous: true

must_haves:
  truths:
    - "User clicks the root name node to start the reveal (mouse-enter no longer triggers it)"
    - "Career nodes appear in reverse-chronological order: Intenseye first, then Layermark, then Bilkent"
    - "The reveal sequence can be interrupted/aborted without leaving the graph in a broken state"
    - "No fitView prop or debouncedFitView calls remain anywhere in graph-section.tsx"
  artifacts:
    - path: "lib/stores/graph-store.tsx"
      provides: "Reveal state machine with idle/revealing/revealed/aborted states"
      contains: "revealPhase"
    - path: "lib/layout-constants.ts"
      provides: "Updated reveal timing with reverse-chronological order"
      contains: "REVEAL_SEQUENCE"
    - path: "components/sections/graph-section.tsx"
      provides: "Click-triggered reveal with state machine, no fitView"
    - path: "components/custom-node.tsx"
      provides: "Root node with onClick handler for reveal trigger"
  key_links:
    - from: "components/custom-node.tsx"
      to: "components/sections/graph-section.tsx"
      via: "data.onClickReveal callback prop on root node"
      pattern: "onClickReveal"
    - from: "components/sections/graph-section.tsx"
      to: "lib/stores/graph-store.tsx"
      via: "useGraphStore for state machine transitions"
      pattern: "useGraphStore.*revealPhase"
    - from: "components/sections/graph-section.tsx"
      to: "lib/layout-constants.ts"
      via: "REVEAL_SEQUENCE for node order and timing"
      pattern: "REVEAL_SEQUENCE"
---

<objective>
Replace the setTimeout cascade and mouse-enter trigger with a state machine reveal system driven by clicking the root node, playing career nodes in reverse-chronological order (Intenseye -> Layermark -> Bilkent). Remove all fitView props and debouncedFitView calls to prepare for Phase 14 camera choreography.

Purpose: Foundation for cinematic career reveal -- clean state transitions enable camera choreography and interruption handling in later phases.
Output: Refactored graph store, updated graph section, and click-triggerable root node.
</objective>

<execution_context>
@/Users/sunny/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sunny/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/stores/graph-store.tsx
@lib/layout-constants.ts
@components/sections/graph-section.tsx
@components/custom-node.tsx
@lib/graph-utils.ts
@lib/debounce.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add reveal state machine to graph store and update timing constants</name>
  <files>lib/stores/graph-store.tsx, lib/layout-constants.ts</files>
  <action>
**graph-store.tsx -- Add reveal state machine:**

1. Add a `RevealPhase` type: `'idle' | 'revealing' | 'revealed' | 'aborted'`

2. Add new state fields:
   - `revealPhase: RevealPhase` (initially `'idle'`)
   - `revealStep: number` (initially `-1`, index into REVEAL_SEQUENCE)
   - `revealTimerIds: NodeJS.Timeout[]` (for cleanup on abort)

3. Add new actions:
   - `beginReveal()`: Only transitions if `revealPhase === 'idle'`. Sets `revealPhase: 'revealing'`, `revealStep: 0`.
   - `advanceReveal()`: Increments `revealStep`. If step reaches sequence length, sets `revealPhase: 'revealed'`.
   - `abortReveal()`: Clears all timers in `revealTimerIds`, sets `revealPhase: 'aborted'`. Does NOT reset nodes (graph keeps whatever was already revealed -- no broken state).
   - `registerRevealTimer(id: NodeJS.Timeout)`: Pushes timer id into `revealTimerIds` array.
   - `clearRevealTimers()`: Clears all timers in `revealTimerIds` and empties the array.

4. Keep existing `hasStartedReveal` as a computed getter: `get().revealPhase !== 'idle'`
   - Actually, since Zustand doesn't have computed getters natively, replace `hasStartedReveal` boolean with the `revealPhase` field. Update `startReveal()` to call `beginReveal()` internally for backward compatibility during this transition. The old `hasStartedReveal` field and `startReveal()` action can be removed -- the new `revealPhase` replaces them.

5. Keep all existing node expansion state (expandedNodes, revealedCompanies, etc.) unchanged.

**layout-constants.ts -- Add REVEAL_SEQUENCE:**

1. Add a `REVEAL_SEQUENCE` constant array that defines the reveal order:

   ```ts
   export const REVEAL_SEQUENCE = [
     { nodeId: "Intenseye", delayMs: 600 },
     { nodeId: "Layermark", delayMs: 600 },
     { nodeId: "Bilkent", delayMs: 600 },
   ] as const;
   ```

   This is reverse-chronological (most recent first). Each step waits `delayMs` after the previous step completes its entrance animation. The soft-skill nodes are NOT in the sequence -- they will be handled separately in Phase 15 (VISUAL-04 converts them to badges on root node).

2. Keep existing `REVEAL_TIMING` constants (they may still be referenced elsewhere) but mark them with a `@deprecated` JSDoc comment noting they are superseded by `REVEAL_SEQUENCE`.

3. Add `SOFT_SKILL_NODE_IDS` constant:
   ```ts
   export const SOFT_SKILL_NODE_IDS = [
     "Problem-Solving",
     "Collaboration",
     "Quick-Learner",
   ] as const;
   ```
   This centralizes the magic strings currently scattered in graph-section.tsx.
   </action>
   <verify>
   Run `npx tsc --noEmit` from project root -- no type errors.
   Grep for `revealPhase` in graph-store.tsx -- must exist.
   Grep for `REVEAL_SEQUENCE` in layout-constants.ts -- must exist.
   </verify>
   <done>
   graph-store.tsx exports a Zustand store with revealPhase state machine (idle/revealing/revealed/aborted), beginReveal/advanceReveal/abortReveal actions, and timer registration.
   layout-constants.ts exports REVEAL_SEQUENCE with Intenseye -> Layermark -> Bilkent order and SOFT_SKILL_NODE_IDS.
   </done>
   </task>

<task type="auto">
  <name>Task 2: Wire click-to-reveal, state machine sequencing, and remove fitView</name>
  <files>components/sections/graph-section.tsx, components/custom-node.tsx</files>
  <action>
**custom-node.tsx -- Add click handler to root node:**

1. Extend the `data` type for CustomNode to include an optional `onClickReveal?: () => void` callback.

2. In the root node branch (`data.type === 'root'`), add an `onClick` handler on the outermost `motion.div`:

   ```tsx
   onClick={() => data.onClickReveal?.()}
   ```

   Add `cursor-pointer` to the root node's className to indicate clickability.

3. Add a visual hint that the root node is clickable before reveal starts. Add a subtle text label below the name: a small `<div>` with text like "Click to explore career" in `text-xs text-stone-500` that fades away once reveal starts. Pass a `isRevealing: boolean` prop through data to control visibility. When `isRevealing` is true, hide this text (opacity 0 with transition).

**graph-section.tsx -- Replace setTimeout cascade with state machine:**

1. **Remove fitView entirely:**
   - Delete the `debouncedFitView` useMemo (and the `debounce` import if no longer used).
   - Remove `fitView` prop from the `<ReactFlow>` component.
   - Remove the `fitViewOptions` prop from `<ReactFlow>`.
   - Remove the debouncedFitView call from the resize effect.
   - Remove the debouncedFitView.cancel() from the cleanup effect.
   - Keep the `debounce` import ONLY if still used elsewhere; if not, remove it.

2. **Remove onMouseEnter trigger:**
   - Remove `handleGraphEnter` callback entirely.
   - Remove `onMouseEnter={handleGraphEnter}` from the `<motion.div>`.

3. **Replace startRevealSequence with state machine approach:**
   - Import `REVEAL_SEQUENCE`, `SOFT_SKILL_NODE_IDS` from layout-constants.
   - Import `beginReveal`, `advanceReveal`, `abortReveal`, `registerRevealTimer`, `clearRevealTimers` from the graph store.

   - Create a new `handleClickReveal` callback that:
     a. Reads `revealPhase` from store. If not `'idle'`, return early.
     b. Calls `beginReveal()`.
     c. First reveals soft-skill nodes immediately (staggered with 200ms between each, same as current behavior).
     d. After soft skills are done (SOFT_SKILL_NODE_IDS.length \* 200 ms), begins the REVEAL_SEQUENCE loop:
     - For each step in REVEAL_SEQUENCE, schedule a timer at cumulative delay.
     - Each timer calls `addNodeAndEdges(step.nodeId)` then `advanceReveal()`.
     - Register each timer via `registerRevealTimer(id)` so abort can clear them.
       e. After the last step, schedule one final timer that just calls `advanceReveal()` one last time to transition to 'revealed' state (since advanceReveal checks if step reached sequence length).

4. **Pass onClickReveal to root node:**
   - When setting up the initial root node (the `allNodes.filter(n => n.data?.type === 'root')` in useNodesState), add `onClickReveal: handleClickReveal` to its data.
   - Also pass `isRevealing: revealPhase !== 'idle'` so the root node can hide the "click to explore" hint.

5. **Subscribe to revealPhase for root node data updates:**
   - Subscribe to `revealPhase` from the store so that when it changes from 'idle' to 'revealing', the root node's `isRevealing` prop updates. Use a `useEffect` that runs when `revealPhase` changes, updating the root node's data via `setNodes`.

6. **Abort on unmount:**
   - In the cleanup effect (the one that currently clears timersRef), call `abortReveal()` from the store. This clears all scheduled timers and sets phase to 'aborted'.
   - Remove the old `timersRef` pattern entirely -- timer tracking now lives in the store.
   - Remove the `addTimer` callback since timers are now registered via store.

7. **Keep existing node hover/expansion logic** (handleNodeHover, achievementNodeHoverHandler) unchanged -- these are Phase 15 concerns.

8. **Keep the resize observer** for graphDimensions -- still needed for layout recalculation. But remove the debouncedFitView() call from its effect.

9. **Update the resize-triggered node position update effect** (the one at ~line 241-255): Keep the logic that updates node positions when dimensions change, but remove the `debouncedFitView()` call at the end. The camera will be managed in Phase 14.
   </action>
   <verify>
   Run `npx tsc --noEmit` -- no type errors.
   Run `npm run build` (or `npx next build`) -- build succeeds with no errors.
   Grep for `fitView` in graph-section.tsx -- must return NO matches.
   Grep for `debouncedFitView` in graph-section.tsx -- must return NO matches.
   Grep for `onMouseEnter` in graph-section.tsx -- must return NO matches (on the graph container div).
   Grep for `onClickReveal` in custom-node.tsx -- must exist.
   Grep for `REVEAL_SEQUENCE` in graph-section.tsx -- must exist.
   </verify>
   <done>
   Root node click triggers reveal. Nodes appear in Intenseye -> Layermark -> Bilkent order. Mouse-enter trigger removed. fitView prop and debouncedFitView completely removed. Abort on unmount clears all timers. Root node shows "click to explore" hint that disappears on reveal start.
   </done>
   </task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` succeeds
3. No `fitView` or `debouncedFitView` references in graph-section.tsx
4. No `onMouseEnter` handler on the graph container
5. `revealPhase` state machine in graph-store.tsx with idle/revealing/revealed/aborted
6. `REVEAL_SEQUENCE` in layout-constants.ts lists Intenseye, Layermark, Bilkent (in that order)
7. Root node in custom-node.tsx has onClick -> onClickReveal callback
</verification>

<success_criteria>

- Build passes cleanly
- State machine manages reveal lifecycle (idle -> revealing -> revealed, or idle -> revealing -> aborted)
- Click on root node starts reveal; mouse-enter does nothing
- Reveal order is Intenseye -> Layermark -> Bilkent (reverse-chronological)
- Unmount aborts cleanly with no dangling timers
- No fitView or debouncedFitView anywhere in graph code
  </success_criteria>

<output>
After completion, create `.planning/phases/13-state-machine-foundation/13-01-SUMMARY.md`
</output>
