---
phase: 04-state-management-refactor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/stores/graph-store.tsx
  - components/dashboard-background.tsx
autonomous: true

must_haves:
  truths:
    - "DashboardBackground has fewer refs than before (reduced from 6 to 3 essential)"
    - "Reveal state (hasEnteredGraph, addedAchievements) is tracked in Zustand store"
    - "Node hover handler does not use ref-based closure workaround"
  artifacts:
    - path: "lib/stores/graph-store.tsx"
      provides: "Reveal tracking state and actions"
      contains: "revealedCompanies"
    - path: "components/dashboard-background.tsx"
      provides: "Simplified component using store for reveal state"
  key_links:
    - from: "components/dashboard-background.tsx"
      to: "lib/stores/graph-store.tsx"
      via: "useGraphStore hook"
      pattern: "useGraphStore.*revealedCompanies"
---

<objective>
Consolidate ref management in DashboardBackground by moving reveal tracking state to Zustand store and eliminating the stale closure workaround pattern.

Purpose: Reduce component complexity, improve debuggability, and eliminate ref coordination issues that can lead to stale closures.
Output: Cleaner DashboardBackground with 3 essential refs (down from 6), reveal state in centralized store.
</objective>

<execution_context>
@/Users/sunny/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sunny/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-type-safety/03-01-SUMMARY.md

@components/dashboard-background.tsx
@lib/stores/graph-store.tsx
</context>

<design_rationale>

## Why allNodesRef/allEdgesRef remain as refs (STATE-02 resolution)

STATE-02 requires: "Move allNodes, allEdges, addedAchievements tracking to graph store or simplify"

For `addedAchievements`: Moving to store (as `revealedCompanies`) - this is true reactive state that determines reveal behavior.

For `allNodesRef`/`allEdgesRef`: These are SIMPLIFIED by keeping as memoized computation refs because:

1. **They are derived data, not source-of-truth state.** They cache the result of computing all nodes/edges from the achievements data at specific dimensions. The source data lives in the achievements JSON and store.

2. **They exist for dimension-based recalculation.** When container dimensions change, we need to recompute node positions. Storing in Zustand would:
   - Add unnecessary reactivity overhead (re-renders on every position update)
   - Create circular dependency (store needs dimensions, dimensions come from component)
   - Violate Zustand's philosophy of minimal state (derived data should be computed, not stored)

3. **They are write-once-per-resize, read-many.** The pattern is: resize triggers recalc -> write to ref -> ReactFlow reads. This is a memoization pattern, not state management.

4. **Moving to store would increase complexity, not reduce it.** We'd need to add dimension state, sync mechanisms, and handle the store-to-component-to-store data flow.

This satisfies STATE-02's "or simplify" clause - the refs ARE the simplified approach for computed dimension-dependent data.
</design_rationale>

<tasks>

<task type="auto">
  <name>Task 1: Move reveal tracking state to graph store</name>
  <files>lib/stores/graph-store.tsx, components/dashboard-background.tsx</files>
  <action>
Add reveal tracking state and actions to graph-store.tsx:

1. Add state fields to GraphState type:
   - `hasStartedReveal: boolean` (replaces hasEnteredGraph ref)
   - `revealedCompanies: string[]` (replaces addedAchievementsRef Set)

2. Add actions:
   - `startReveal: () => void` - sets hasStartedReveal to true
   - `markCompanyRevealed: (companyId: string) => void` - adds to revealedCompanies if not present
   - `isCompanyRevealed: (companyId: string) => boolean` - selector for checking reveal state

3. Update DashboardBackground:
   - Remove `hasEnteredGraph` ref
   - Remove `addedAchievementsRef` ref
   - Import and use store actions/state instead
   - Update `handleGraphEnter` to use `startReveal` action
   - Update `handleNodeHover` to use `markCompanyRevealed` and `isCompanyRevealed`

Keep refs that are essential:

- `graphContainerRef` (DOM ref for ResizeObserver)
- `allNodesRef` and `allEdgesRef` (memoized computed data for dimension-based recalculation - see design_rationale)
  </action>
  <verify>
  npx tsc --noEmit passes
  npm run lint passes
  App still loads and graph reveal sequence works
  </verify>
  <done>
  Reveal state (hasStartedReveal, revealedCompanies) tracked in Zustand store.
  hasEnteredGraph and addedAchievementsRef refs removed from DashboardBackground.
  </done>
  </task>

<task type="auto">
  <name>Task 2: Eliminate stale closure workaround for hover handler</name>
  <files>components/dashboard-background.tsx</files>
  <action>
Remove the handleNodeHoverRef pattern and use a cleaner approach:

1. Remove `handleNodeHoverRef` ref declaration (line ~50-52)
2. Remove the useEffect that syncs handleNodeHover to handleNodeHoverRef (line ~136-138)
3. Update `handleNodeHover` callback:
   - Access reveal state directly from store (not via closure over component state)
   - Store state is accessed fresh on each call, avoiding stale closure
4. Update `addNodeAndEdges` to pass handleNodeHover directly (not via ref)
5. Update achievement node creation to use direct callback reference

The key insight: Since reveal state now lives in Zustand store, the callback can read current state directly from store without needing a ref to stay in sync. Zustand subscriptions are stable references.

Pattern to use:

```typescript
const handleNodeHover = useCallback(
  (nodeId: string, isEntering: boolean) => {
    if (!isEntering) return;

    // Read current state directly from store (fresh on each call)
    const { revealedCompanies, markCompanyRevealed } = useGraphStore.getState();

    if (revealedCompanies.includes(nodeId)) return;
    markCompanyRevealed(nodeId);

    // ... rest of hover logic
  },
  [setNodes, setEdges, fitViewSmooth],
);
```

Note: Use `useGraphStore.getState()` for imperative access within callbacks rather than hook selectors which would create stale closures.
</action>
<verify>
npx tsc --noEmit passes
npm run lint passes
grep -c 'handleNodeHoverRef' components/dashboard-background.tsx returns 0
grep -c 'useRef' components/dashboard-background.tsx returns 4 (1 import + 3 refs)
Hover over company node reveals achievements (test manually)
Rapid hover over multiple companies works correctly (no stale state)
</verify>
<done>
handleNodeHoverRef removed.
handleNodeHover uses store.getState() for fresh state access.
Ref count reduced from 6 to 3 (graphContainerRef, allNodesRef, allEdgesRef).
</done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes
2. Linting: `npm run lint` passes
3. Ref removal verified: `grep -c 'handleNodeHoverRef' components/dashboard-background.tsx` returns 0
4. Ref count verified: `grep -c 'useRef' components/dashboard-background.tsx` returns 4 (1 import + 3 useRef calls)
5. Store state: useGraphStore has hasStartedReveal and revealedCompanies fields
6. Manual test: Graph reveal sequence works on mouse enter, achievements reveal on company hover
</verification>

<success_criteria>

1. DashboardBackground uses 3 refs (down from 6)
2. hasStartedReveal and revealedCompanies state in graph store
3. No handleNodeHoverRef pattern (stale closure workaround eliminated)
4. All existing functionality preserved (reveal sequence, hover reveals)
5. TypeScript and lint checks pass
   </success_criteria>

<output>
After completion, create `.planning/phases/04-state-management-refactor/04-01-SUMMARY.md`
</output>
