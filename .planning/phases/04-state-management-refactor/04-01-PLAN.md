---
phase: 04-state-management-refactor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/stores/graph-store.tsx
  - components/dashboard-background.tsx
autonomous: true

must_haves:
  truths:
    - "DashboardBackground has fewer refs than before (reduced from 6 to 3 essential)"
    - "Reveal state (hasEnteredGraph, addedAchievements) is tracked in Zustand store"
    - "Node hover handler does not use ref-based closure workaround"
  artifacts:
    - path: "lib/stores/graph-store.tsx"
      provides: "Reveal tracking state and actions"
      contains: "revealedCompanies"
    - path: "components/dashboard-background.tsx"
      provides: "Simplified component using store for reveal state"
  key_links:
    - from: "components/dashboard-background.tsx"
      to: "lib/stores/graph-store.tsx"
      via: "useGraphStore hook"
      pattern: "useGraphStore.*revealedCompanies"
---

<objective>
Consolidate ref management in DashboardBackground by moving reveal tracking state to Zustand store and eliminating the stale closure workaround pattern.

Purpose: Reduce component complexity, improve debuggability, and eliminate ref coordination issues that can lead to stale closures.
Output: Cleaner DashboardBackground with 3 essential refs (down from 6), reveal state in centralized store.
</objective>

<execution_context>
@/Users/sunny/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sunny/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-type-safety/03-01-SUMMARY.md

@components/dashboard-background.tsx
@lib/stores/graph-store.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move reveal tracking state to graph store</name>
  <files>lib/stores/graph-store.tsx, components/dashboard-background.tsx</files>
  <action>
Add reveal tracking state and actions to graph-store.tsx:

1. Add state fields to GraphState type:
   - `hasStartedReveal: boolean` (replaces hasEnteredGraph ref)
   - `revealedCompanies: string[]` (replaces addedAchievementsRef Set)

2. Add actions:
   - `startReveal: () => void` - sets hasStartedReveal to true
   - `markCompanyRevealed: (companyId: string) => void` - adds to revealedCompanies if not present
   - `isCompanyRevealed: (companyId: string) => boolean` - selector for checking reveal state

3. Update DashboardBackground:
   - Remove `hasEnteredGraph` ref
   - Remove `addedAchievementsRef` ref
   - Import and use store actions/state instead
   - Update `handleGraphEnter` to use `startReveal` action
   - Update `handleNodeHover` to use `markCompanyRevealed` and `isCompanyRevealed`

Keep refs that are essential:

- `graphContainerRef` (DOM ref for ResizeObserver)
- `allNodesRef` and `allEdgesRef` (memoized computed data, needed for dimension-based recalculation)
  </action>
  <verify>
  npx tsc --noEmit passes
  npm run lint passes
  App still loads and graph reveal sequence works
  </verify>
  <done>
  Reveal state (hasStartedReveal, revealedCompanies) tracked in Zustand store.
  hasEnteredGraph and addedAchievementsRef refs removed from DashboardBackground.
  </done>
  </task>

<task type="auto">
  <name>Task 2: Eliminate stale closure workaround for hover handler</name>
  <files>components/dashboard-background.tsx</files>
  <action>
Remove the handleNodeHoverRef pattern and use a cleaner approach:

1. Remove `handleNodeHoverRef` ref declaration (line ~50-52)
2. Remove the useEffect that syncs handleNodeHover to handleNodeHoverRef (line ~136-138)
3. Update `handleNodeHover` callback:
   - Access reveal state directly from store (not via closure over component state)
   - Store state is accessed fresh on each call, avoiding stale closure
4. Update `addNodeAndEdges` to pass handleNodeHover directly (not via ref)
5. Update achievement node creation to use direct callback reference

The key insight: Since reveal state now lives in Zustand store, the callback can read current state directly from store without needing a ref to stay in sync. Zustand subscriptions are stable references.

Pattern to use:

```typescript
const handleNodeHover = useCallback(
  (nodeId: string, isEntering: boolean) => {
    if (!isEntering) return;

    // Read current state directly from store (fresh on each call)
    const { revealedCompanies, markCompanyRevealed } = useGraphStore.getState();

    if (revealedCompanies.includes(nodeId)) return;
    markCompanyRevealed(nodeId);

    // ... rest of hover logic
  },
  [setNodes, setEdges, fitViewSmooth],
);
```

Note: Use `useGraphStore.getState()` for imperative access within callbacks rather than hook selectors which would create stale closures.
</action>
<verify>
npx tsc --noEmit passes
npm run lint passes
Hover over company node reveals achievements (test manually)
Rapid hover over multiple companies works correctly (no stale state)
</verify>
<done>
handleNodeHoverRef removed.
handleNodeHover uses store.getState() for fresh state access.
Ref count reduced from 6 to 3 (graphContainerRef, allNodesRef, allEdgesRef).
</done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes
2. Linting: `npm run lint` passes
3. Ref count: DashboardBackground has exactly 3 useRef calls (graphContainerRef, allNodesRef, allEdgesRef)
4. Store state: useGraphStore has hasStartedReveal and revealedCompanies fields
5. Manual test: Graph reveal sequence works on mouse enter, achievements reveal on company hover
</verification>

<success_criteria>

1. DashboardBackground uses 3 refs (down from 6)
2. hasStartedReveal and revealedCompanies state in graph store
3. No handleNodeHoverRef pattern (stale closure workaround eliminated)
4. All existing functionality preserved (reveal sequence, hover reveals)
5. TypeScript and lint checks pass
   </success_criteria>

<output>
After completion, create `.planning/phases/04-state-management-refactor/04-01-SUMMARY.md`
</output>
