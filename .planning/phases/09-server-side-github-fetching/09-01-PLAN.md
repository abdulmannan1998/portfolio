---
phase: 09-server-side-github-fetching
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/github.ts
  - components/github-activity.tsx
  - components/sections/tech-and-code-section.tsx
  - app/api/github/route.ts
autonomous: true

must_haves:
  truths:
    - "GitHubActivity component is purely presentational -- receives commits as props, contains no fetch or cache logic"
    - "No module-level Map cache exists in github-activity.tsx"
    - "Server-side fetch function exists in lib/github.ts with ISR revalidation (5 min)"
    - "API route delegates to shared fetchGitHubCommits function"
    - "GitHub activity section still renders commits with correct styling after refactor"
  artifacts:
    - path: "lib/github.ts"
      provides: "Server-side GitHub fetch function and RedactedCommit type"
      exports: ["fetchGitHubCommits", "RedactedCommit"]
    - path: "components/github-activity.tsx"
      provides: "Presentational GitHub activity renderer"
      contains: "commits: RedactedCommit[] in props"
    - path: "app/api/github/route.ts"
      provides: "Thin API route delegating to lib/github.ts"
  key_links:
    - from: "lib/github.ts"
      to: "GitHub Events API"
      via: "server-side fetch with next revalidate"
      pattern: "fetch.*api\\.github\\.com.*next.*revalidate"
    - from: "app/api/github/route.ts"
      to: "lib/github.ts"
      via: "import and delegation"
      pattern: "import.*fetchGitHubCommits.*from.*lib/github"
    - from: "components/sections/tech-and-code-section.tsx"
      to: "components/github-activity.tsx"
      via: "passing commits as props"
      pattern: "commits=\\{commits\\}"
---

<objective>
Extract GitHub fetch logic into a shared server-side function with ISR, refactor GitHubActivity to be purely presentational, and wire the data flow through the section component.

Purpose: Prepare the architecture for zero-flash server-side rendering of GitHub data. The shared fetch function enables both the API route and future server components (Phase 11) to fetch GitHub data with ISR caching.

Output: `lib/github.ts` (shared fetch + types), presentational `github-activity.tsx`, thin API route, and updated `tech-and-code-section.tsx` bridging the data.
</objective>

<execution_context>
@/Users/sunny/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sunny/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@app/api/github/route.ts
@components/github-activity.tsx
@components/sections/tech-and-code-section.tsx
@lib/social-links.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract shared GitHub fetch function into lib/github.ts</name>
  <files>lib/github.ts, app/api/github/route.ts</files>
  <action>
Create `lib/github.ts` by extracting core fetch logic from `app/api/github/route.ts`:

1. Move these items from the route into `lib/github.ts`:
   - `RedactedCommit` type (export it)
   - `GitHubEvent` type
   - `GitHubCommitResponse` type
   - `GITHUB_USERNAME` constant
   - `makeHeaders()` function

2. Create and export an async `fetchGitHubCommits()` function containing the fetch logic currently inside the route's `GET()` handler. Key differences from the route version:
   - All `fetch()` calls use `{ next: { revalidate: 300 } }` instead of `{ cache: "no-store" }` -- this tells Next.js to cache and revalidate every 5 minutes via ISR
   - Return type is `RedactedCommit[]` (not NextResponse)
   - On any error (API failure, network error), return `[]` for graceful degradation
   - Log errors to console.error just like the current route does

3. Simplify `app/api/github/route.ts`:
   - Import `fetchGitHubCommits` from `@/lib/github`
   - The `GET()` handler becomes: call `fetchGitHubCommits()`, wrap result in `NextResponse.json({ commits })`
   - Keep the `Cache-Control: public, s-maxage=300, stale-while-revalidate=600` headers on the response
   - Remove all moved types/constants/functions -- the route should be ~15 lines
     </action>
     <verify>
     Run `npx tsc --noEmit` -- no type errors. Confirm `lib/github.ts` exports `fetchGitHubCommits` and `RedactedCommit`. Confirm `app/api/github/route.ts` is now a thin wrapper importing from `@/lib/github`.
     </verify>
     <done>lib/github.ts exists with fetchGitHubCommits() using ISR revalidation. API route is a thin wrapper delegating to the shared function. No duplicate type definitions between files.</done>
     </task>

<task type="auto">
  <name>Task 2: Refactor GitHubActivity to presentational and update data flow</name>
  <files>components/github-activity.tsx, components/sections/tech-and-code-section.tsx</files>
  <action>
**Refactor `components/github-activity.tsx` to be purely presentational:**

1. Remove the `"use client"` directive from the top of the file.

2. Remove these imports: `useState`, `useEffect`.

3. Delete ALL caching code (lines 23-51 in current file):
   - `CacheEntry` type
   - `commitCache` Map
   - `CACHE_TTL` constant
   - `getCachedCommits()` function
   - `setCachedCommits()` function

4. Delete the duplicate `RedactedCommit` type definition. Import it from `@/lib/github` instead.

5. Change `GitHubActivityProps` to:

   ```typescript
   export type GitHubActivityProps = {
     commits: RedactedCommit[];
     username: string;
   };
   ```

   Both props are required.

6. Remove the `loading` and `error` state declarations. Remove the entire `useEffect` block (the fetch-on-mount logic).

7. Simplify the JSX render:
   - Remove the loading skeleton branch (`loading ? <div className="space-y-4">...`)
   - Remove the error branch (`error ? <p>...`)
   - Keep only: the header (with LIVE badge checking `commits.length > 0` instead of `!loading && commits.length > 0`), the empty state (`commits.length === 0`), and the commits list
   - The component signature becomes `export function GitHubActivity({ commits, username }: GitHubActivityProps)`

8. Keep `formatTimeAgo()` and `Redacted` sub-component unchanged -- they are pure functions/components with no client APIs.

**Update `components/sections/tech-and-code-section.tsx` to bridge data:**

This file remains `"use client"` (it uses framer-motion). It temporarily takes over the client-side fetch responsibility that was removed from GitHubActivity:

1. Add imports:

   ```typescript
   import { useState, useEffect } from "react";
   import type { RedactedCommit } from "@/lib/github";
   ```

2. Inside the `TechAndCodeSection` function body, add state and fetch:

   ```typescript
   const [commits, setCommits] = useState<RedactedCommit[]>([]);

   useEffect(() => {
     fetch("/api/github")
       .then((res) => res.json())
       .then((data) => setCommits(data.commits || []))
       .catch(() => setCommits([]));
   }, []);
   ```

3. Update the GitHubActivity usage to pass commits:
   ```tsx
   <GitHubActivity commits={commits} username={SOCIAL_LINKS.github.username} />
   ```

**Why this temporary bridge:** page.tsx is still `"use client"`, so we cannot use async server components yet. The fetch logic moves from GitHubActivity (which becomes presentational) into TechAndCodeSection (which already is "use client"). In Phase 11, when page.tsx becomes a server component, the fetch will move to the server level and pass data down as props. This bridge is intentionally temporary.
</action>
<verify>

1. Run `npm run build` -- build succeeds with no errors.
2. Verify GitHubActivity has no client code: `grep -c "useEffect\|useState\|commitCache\|new Map" components/github-activity.tsx` returns 0.
3. Verify no "use client" in github-activity.tsx: `grep -c "use client" components/github-activity.tsx` returns 0.
4. Run `npm run dev`, visit the page, confirm GitHub activity section renders commits with correct styling (redaction badges, timestamps, visibility icons, links).
   </verify>
   <done>GitHubActivity is purely presentational with no fetch, no cache, no useState/useEffect. TechAndCodeSection bridges the data fetch temporarily. The GitHub section renders correctly with commits passed as props.</done>
   </task>

</tasks>

<verification>
After both tasks complete, verify all requirements:

1. **DATA-01 (prep):** `lib/github.ts` exports `fetchGitHubCommits` callable from server components -- `grep "export async function fetchGitHubCommits" lib/github.ts`
2. **DATA-02:** ISR configured -- `grep "revalidate.*300" lib/github.ts` shows the revalidation config
3. **DATA-03:** No module-level cache -- `grep -c "new Map\|commitCache" components/github-activity.tsx` returns 0
4. **DATA-04:** Presentational component -- `grep "commits: RedactedCommit" components/github-activity.tsx` shows props-based interface
5. **Build passes:** `npm run build` succeeds
6. **No visual regression:** GitHub activity section displays commits with correct styling
   </verification>

<success_criteria>

- lib/github.ts exports fetchGitHubCommits() with { next: { revalidate: 300 } } for ISR
- lib/github.ts exports RedactedCommit type as single source of truth
- components/github-activity.tsx has no "use client", no useState/useEffect, no Map cache, no fetch logic
- components/github-activity.tsx accepts { commits: RedactedCommit[]; username: string } as props
- app/api/github/route.ts is a thin wrapper delegating to fetchGitHubCommits()
- Build succeeds with no type errors
- GitHub section renders correctly on the page
  </success_criteria>

<output>
After completion, create `.planning/phases/09-server-side-github-fetching/09-01-SUMMARY.md`
</output>
