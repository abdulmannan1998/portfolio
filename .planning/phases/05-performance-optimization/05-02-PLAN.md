---
phase: 05-performance-optimization
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - components/dashboard-background.tsx
autonomous: true

must_haves:
  truths:
    - "FitView is batched into single debounced call during reveal sequence"
    - "Reveal sequence uses cleaner timing pattern without per-node fitViewSmooth calls"
  artifacts:
    - path: "components/dashboard-background.tsx"
      provides: "Debounced fitView and optimized reveal sequence"
      contains: "debouncedFitView"
  key_links:
    - from: "components/dashboard-background.tsx"
      to: "lib/debounce.ts"
      via: "import debounce"
      pattern: "import.*debounce.*from.*lib/debounce"
---

<objective>
Batch fitView calls using debouncing and optimize the reveal sequence timing pattern.

Purpose: Reduce fitView calls from 7+ to 1-2 during reveal sequence, eliminating layout recalculation overhead. Replace per-node fitView calls with single debounced call at sequence completion.

Output: Debounced fitView using existing lib/debounce.ts; reveal sequence schedules single fitView at end instead of after each node.
</objective>

<execution_context>
@/Users/sunny/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sunny/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-performance-optimization/05-RESEARCH.md
@.planning/phases/05-performance-optimization/05-01-SUMMARY.md

@components/dashboard-background.tsx
@lib/debounce.ts
@lib/layout-constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create debounced fitView function</name>
  <files>components/dashboard-background.tsx</files>
  <action>
Add debounced fitView to batch multiple rapid calls.

1. Import debounce utility:

```typescript
import { debounce } from "@/lib/debounce";
```

2. Create debounced fitView with useRef (to maintain stable reference):

```typescript
const debouncedFitView = useRef(
  debounce(() => {
    reactFlowInstance?.fitView({
      padding: 0.15,
      duration: 800,
      maxZoom: 0.85,
      minZoom: 0.65,
    });
  }, 150),
).current;
```

Place this AFTER reactFlowInstance is defined (line 45).

3. Keep the existing `fitViewSmooth` function for now - we'll update its callers in the next task.

Note: Using 150ms debounce window - imperceptible to users but batches rapid calls effectively.
</action>
<verify>
Run `npx tsc --noEmit` - no TypeScript errors.
</verify>
<done>
Debounced fitView function exists using lib/debounce.ts utility.
</done>
</task>

<task type="auto">
  <name>Task 2: Optimize reveal sequence and achievement reveal to use debounced fitView</name>
  <files>components/dashboard-background.tsx</files>
  <action>
Replace per-node fitView calls with single debounced call.

1. Update startRevealSequence (lines 181-216):
   - Remove fitViewSmooth() call from inside the forEach callback (line 195)
   - Remove fitViewSmooth() calls from each setTimeout (lines 202, 208, 214)
   - Add single debouncedFitView() call at the end of the sequence:

   ```typescript
   // Single fitView at sequence completion
   setTimeout(() => {
     debouncedFitView();
   }, REVEAL_TIMING.INTENSEYE_DELAY_MS + 500);
   ```

   - Update dependency array to include debouncedFitView

2. Update handleNodeHover (lines 91-145):
   - Replace fitViewSmooth() (line 140) with debouncedFitView()
   - Update dependency array to include debouncedFitView

3. Update dimension change effect (around line 269):
   - Replace fitViewSmooth() with debouncedFitView()
   - Update dependency array

4. Remove the fitViewSmooth function entirely since it's no longer needed.

5. Update all dependency arrays that referenced fitViewSmooth to reference debouncedFitView instead.

Result: 7+ fitView calls during reveal â†’ 1-2 debounced calls.
</action>
<verify>
Run `npx tsc --noEmit` - no TypeScript errors.
Run `npm run build` - build succeeds.
Grep for fitViewSmooth - should find 0 occurrences.
</verify>
<done>
Reveal sequence uses single debounced fitView at completion; achievement hover uses debounced fitView; dimension changes use debounced fitView. No more fitViewSmooth function.
</done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npx tsc --noEmit`
2. Build succeeds: `npm run build`
3. Code review: No fitViewSmooth function exists
4. Code review: debouncedFitView uses 150ms debounce window
5. Code review: startRevealSequence has single fitView call at end (not per-node)
6. Grep verification: `grep -n "fitViewSmooth" components/dashboard-background.tsx` returns no matches
</verification>

<success_criteria>

- PERF-01 complete: FitView calls debounced, reducing 7+ calls to 1-2 during reveal
- PERF-02 complete: Reveal sequence uses cleaner pattern with single fitView at completion
- No TypeScript errors
- Build succeeds
- fitViewSmooth function removed (no longer needed)
  </success_criteria>

<output>
After completion, create `.planning/phases/05-performance-optimization/05-02-SUMMARY.md`
</output>
